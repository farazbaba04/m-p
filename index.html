<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Company Connect PRO</title>

<style>
body{margin:0;font-family:Segoe UI;background:#f3f4f6;}
header{background:#111827;color:white;padding:15px;text-align:center;font-size:20px;}
.container{max-width:1000px;margin:auto;padding:20px;}
.card{background:white;padding:20px;border-radius:12px;margin-bottom:15px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
input,textarea,select{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc;}
button{background:#2563eb;color:white;padding:7px 14px;border:none;border-radius:8px;cursor:pointer;margin:5px 3px;}
.reply{margin-left:20px;background:#f9fafb;padding:10px;border-radius:8px;margin-top:8px;}
.like{background:green;}
.admin{background:red;}
.status{padding:3px 8px;border-radius:6px;font-size:12px;color:white;}
.pending{background:orange;}
.solved{background:green;}
.logout{float:right;background:#dc2626;}
small{color:gray;}
</style>
</head>

<body>

<header>
üè¢ Company Connect PRO
<button class="logout" id="logoutBtn" style="display:none;">Logout</button>
</header>

<div class="container">

<div class="card" id="authBox">
<h3>Login / Register</h3>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<input type="text" id="name" placeholder="Full Name">
<input type="text" id="designation" placeholder="Designation">
<input type="text" id="location" placeholder="Location">
<button id="registerBtn">Register</button>
<button id="loginBtn">Login</button>
</div>

<div id="appSection" style="display:none;">

<div class="card">
<h3>Create Post</h3>
<select id="type">
<option value="Problem">Problem</option>
<option value="Suggestion">Suggestion</option>
<option value="Fun Fact">Fun Fact</option>
</select>
<textarea id="content" placeholder="Write something..."></textarea>
<button id="postBtn">Post</button>
</div>

<div id="posts"></div>

</div>
</div>

<script type="module">

// üî• IMPORTS (Version fixed to match your screenshot 10.12.0)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, query, orderBy, updateDoc, deleteDoc } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// üî• YOUR CONFIG (Added exactly from your screenshot)
const firebaseConfig = {
  apiKey: "AIzaSyCy6ytqB1uQD8mlJjrmH9gHCuZh9hHDDaQ",
  authDomain: "mnp-29c95.firebaseapp.com",
  projectId: "mnp-29c95",
  storageBucket: "mnp-29c95.firebasestorage.app",
  messagingSenderId: "314074925404",
  appId: "1:314074925404:web:4c5d74346690b0ff905999",
  measurementId: "G-YP7O7YTXPN"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// üëë SET ADMIN EMAIL (Added missing quotes)
const adminEmail = "faraz.nadeem@mulphilog.com";

let currentUserData = {};
let currentUser = null;

// REGISTER
document.getElementById('registerBtn').onclick = async ()=>{
    let emailVal = document.getElementById('email').value;
    let passVal = document.getElementById('password').value;

    try {
        let userCred = await createUserWithEmailAndPassword(auth, emailVal, passVal);
        await setDoc(doc(db, "users", userCred.user.uid), {
            name: document.getElementById('name').value,
            designation: document.getElementById('designation').value,
            location: document.getElementById('location').value,
            email: emailVal
        });
        alert("Registered successfully!");
    } catch (error) {
        alert(error.message);
    }
};

// LOGIN
document.getElementById('loginBtn').onclick = async ()=>{
    let emailVal = document.getElementById('email').value;
    let passVal = document.getElementById('password').value;
    try {
        await signInWithEmailAndPassword(auth, emailVal, passVal);
    } catch (error) {
        alert(error.message);
    }
};

// AUTH STATE
onAuthStateChanged(auth, async(user)=>{
    if(user){
        currentUser = user;
        document.getElementById('authBox').style.display = "none";
        document.getElementById('appSection').style.display = "block";
        document.getElementById('logoutBtn').style.display = "inline-block";

        let docSnap = await getDoc(doc(db,"users",user.uid));
        if (docSnap.exists()) {
            currentUserData = docSnap.data();
        }

        loadPosts();
    }else{
        document.getElementById('authBox').style.display = "block";
        document.getElementById('appSection').style.display = "none";
        document.getElementById('logoutBtn').style.display = "none";
    }
});

// LOGOUT
document.getElementById('logoutBtn').onclick = ()=> signOut(auth);

// CREATE POST
document.getElementById('postBtn').onclick = async()=>{
    let contentVal = document.getElementById('content').value;
    let typeVal = document.getElementById('type').value;

    if(!contentVal) return;

    await addDoc(collection(db,"posts"),{
        content: contentVal,
        type: typeVal,
        name: currentUserData.name || "Unknown",
        designation: currentUserData.designation || "",
        location: currentUserData.location || "",
        likes: 0,
        status: "Pending",
        time: new Date()
    });
    document.getElementById('content').value = "";
};

// LOAD POSTS REALTIME
function loadPosts(){
    const q = query(collection(db,"posts"), orderBy("time","desc"));

    onSnapshot(q,(snapshot)=>{
        const postsDiv = document.getElementById('posts');
        postsDiv.innerHTML = "";
        
        snapshot.forEach(docSnap=>{
            let post = docSnap.data();
            let id = docSnap.id;

            let div = document.createElement("div");
            div.className = "card";

            div.innerHTML=`
            <b>${post.name}</b> (${post.designation} - ${post.location})<br>
            <b>Type:</b> ${post.type}<br>
            ${post.content}<br>
            <span class="status ${post.status==="Solved"?"solved":"pending"}">${post.status}</span><br>
            <button class="like" onclick="likePost('${id}',${post.likes})">üëç ${post.likes}</button>
            <button onclick="replyBox('${id}')">Reply</button>
            ${currentUser?.email === adminEmail ? `
            <button class="admin" onclick="deletePost('${id}')">Delete</button>
            <button onclick="markSolved('${id}')">Mark Solved</button>
            `:``}
            <div id="reply_${id}"></div>
            `;

            postsDiv.appendChild(div);
            loadReplies(id);
        });
    });
}

// LIKE
window.likePost = async(id, likes)=>{
    await updateDoc(doc(db,"posts",id), {likes: likes+1});
};

// DELETE
window.deletePost = async(id)=>{
    await deleteDoc(doc(db,"posts",id));
};

// MARK SOLVED
window.markSolved = async(id)=>{
    await updateDoc(doc(db,"posts",id), {status: "Solved"});
};

// REPLY BOX
window.replyBox = (id)=>{
    document.getElementById("reply_"+id).innerHTML=`
    <textarea id="replyInput_${id}" placeholder="Write reply..."></textarea>
    <button onclick="sendReply('${id}')">Send</button>
    <div id="replyList_${id}"></div>
    `;
};

// SEND REPLY
window.sendReply = async(id)=>{
    let text = document.getElementById("replyInput_"+id).value;
    if(!text) return;

    await addDoc(collection(db,"posts",id,"replies"),{
        text: text,
        name: currentUserData.name || "Unknown",
        time: new Date()
    });
    document.getElementById("replyInput_"+id).value = "";
};

// LOAD REPLIES
function loadReplies(postId){
    const q = query(collection(db,"posts",postId,"replies"), orderBy("time"));
    onSnapshot(q,(snap)=>{
        let box = document.getElementById("replyList_"+postId);
        if(!box) return;
        box.innerHTML = "";
        snap.forEach(docSnap=>{
            let r = docSnap.data();
            box.innerHTML+=`
            <div class="reply">
            <b>${r.name}</b><br>
            ${r.text}<br>
            <small>${r.time.toDate().toLocaleString()}</small>
            </div>`;
        });
    });
}

</script>
</body>
</html>
